version: "3.9"

x-common-config:
  signal-bot: &signal-bot-common
    build: https://github.com/jamesoncollins/turbo-bot.git#main:docker_bot
    restart: always
    stdin_open: true # docker run -i
    tty: true        # docker run -t
    depends_on:
      - signal-cli
    environment:
      GIT_REPO_URL: https://github.com/jamesoncollins/turbo-bot.git
      GIT_REPO_PATH: /root/git/$(hostname)
    entrypoint: ["/bin/bash", "-c"]
    command: >
      mkdir -p ${GIT_REPO_PATH} 
      && cd ${GIT_REPO_PATH} 
      && ( git clone -b ${GIT_REPO_BRANCH} ${GIT_REPO_URL} ${GIT_REPO_PATH} || true ) 
      && cd turbo-bot && git config --global --add safe.directory ${GIT_REPO_PATH}
      && git reset --hard 
      && git pull 
      && pip install -r requirements.txt 
      && apt -y install $(cat pkglist) 
      && ${GIT_REPO_PATH}/run.sh
    volumes:
      - signal-cli-data:${GIT_REPO_PATH}

services:
  signal-cli:
    container_name: signal-cli
    image: bbernhard/signal-cli-rest-api:latest
    stdin_open: true # docker run -i
    tty: true        # docker run -t
    environment:
      #- MODE=normal #supported modes: json-rpc, native, normal
      - MODE=json-rpc
      #- AUTO_RECEIVE_SCHEDULE=0 22 * * * #enable this parameter on demand (see description below)
      - PORT=8181
    ports:
      - "8181:8181" #map docker port 8080 to host port 8080.
    volumes:
      - "signal-cli-data:/home/.local/share/signal-cli"

  signal-bot:
    <<: *signal-bot-common
    container_name: turbo-bot
    environment:
      <<: *signal-bot-common.environment
      GIT_REPO_BRANCH: main

  signal-bot-devel:
    <<: *signal-bot-common
    container_name: turbo-bot-devel
    environment:
      <<: *signal-bot-common.environment
      GIT_REPO_BRANCH: devel

volumes:
  signal-cli-data: # Named volume for persistence
